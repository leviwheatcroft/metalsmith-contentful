<!DOCTYPE html>
<html>
<head>
  <title>README.md</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="doc-style.css" />
  <script src="doc-filelist.js"></script>
  <script>
    var relativeDir = "";
    var thisFile = "README.md";
    var defaultSidebar = true;
  </script>
  <script src="doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#metalsmith-contentful">metalsmith-contentful</a>
      </div>

      <div class="heading h2">
        <a href="#motivation">motivation</a>
      </div>

      <div class="heading h2">
        <a href="#install">install</a>
      </div>

      <div class="heading h2">
        <a href="#overview">overview</a>
      </div>

      <div class="heading h3">
        <a href="#example">example</a>
      </div>

      <div class="heading h3">
        <a href="#options">options</a>
      </div>

      <div class="heading h3">
        <a href="#contentful-data-structure">contentful data structure</a>
      </div>

      <div class="heading h3">
        <a href="#cache-modes">cache modes</a>
      </div>

      <div class="heading h3">
        <a href="#queries">queries</a>
      </div>

      <div class="heading h3">
        <a href="#file-creation">file creation</a>
      </div>

      <div class="heading h3">
        <a href="#content-types">content types</a>
      </div>

      <div class="heading h3">
        <a href="#locales">locales</a>
      </div>

      <div class="heading h3">
        <a href="#author">Author</a>
      </div>

      <div class="heading h3">
        <a href="#contributing">Contributing</a>
      </div>

      <div class="heading h3">
        <a href="#license">License</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="docs markdown"><div class="pilwrap" id="metalsmith-contentful">
  <h1>
    <a href="#metalsmith-contentful" name="metalsmith-contentful" class="pilcrow"></a>
metalsmith-contentful
  </h1>
</div>
<p><img src="https://nodei.co/npm/metalsmith-contentful.png?downloads=true&amp;downloadRank=true&amp;stars=true" alt="nodei.co"></p>
<p><img src="https://img.shields.io/npm/v/metalsmith-contentful.svg" alt="npm"> <img src="https://img.shields.io/github/issues/leviwheatcroft/metalsmith-contentful.svg" alt="github-issues"> <img src="https://img.shields.io/github/stars/leviwheatcroft/metalsmith-contentful.svg" alt="stars"> <img src="https://img.shields.io/github/forks/leviwheatcroft/metalsmith-contentful.svg" alt="forks"></p>
<p><a href="https://metalsmith.io">metalsmith</a> plugin to scrape content from contentful</p>
<p>This is not the official <a href="https://github.com/contentful/contentful-metalsmith" title="official contentful-metalsmith plugin">contentful-metalsmith</a> plugin.</p>
<p>Highlights:</p>
<ul>
<li>caches contentful data</li>
<li>configure from metalsmith build call, not from file yaml meta</li>
<li>uses fancy sync api</li>
<li>allows complex queries of data</li>
</ul>
<p>See the <a href="https://leviwheatcroft.github.io/metalsmith-contentful" title="fancy annotated source">annotated source</a> or <a href="https://github.com/leviwheatcroft/metalsmith-contentful" title="github repo">github repo</a></p>
<div class="pilwrap" id="motivation">
  <h2>
    <a href="#motivation" name="motivation" class="pilcrow"></a>
motivation
  </h2>
</div>
<p>I really need caching from remote apis to speed up the metalsmith build process. I couldn't see a way to modify the official plugin to support caching so made something from scratch.</p>
<div class="pilwrap" id="install">
  <h2>
    <a href="#install" name="install" class="pilcrow"></a>
install
  </h2>
</div>
<p><code>npm i --save github:leviwheatcroft/metalsmith-contentful</code></p>
<div class="pilwrap" id="overview">
  <h2>
    <a href="#overview" name="overview" class="pilcrow"></a>
overview
  </h2>
</div>
<p>A contentful space contains <code>entries</code> as defined by <code>content_types</code>, and <code>assets</code> for images or whatever. This plugin scrapes <em>all</em> these items from a given space.</p>
<p>All items are exposed at <code>metalsmith.metadata().contentful</code> in an object keyed by contentful id</p>
<p><code>metalsmith.metadata().contentful</code> also exposes <code>find</code> and <code>findOne</code> functions allowing you to query the items.</p>
<p>The plugin also creates files in the metalsmith files array.</p>
<div class="pilwrap" id="example">
  <h3>
    <a href="#example" name="example" class="pilcrow"></a>
example
  </h3>
</div>
<pre><code class="javascript">Metalsmith(<span class="hljs-string">'src'</span>)
.use(
  contentful({
    <span class="hljs-attr">space</span>: <span class="hljs-string">'aH7WHo2REFrZ6CHbGZx4'</span>,
    <span class="hljs-attr">accessToken</span>: <span class="hljs-string">'9aXKQnP2UjjEeTTUcyGCMAOmhn4Vsf8u'</span>,
    <span class="hljs-attr">files</span>: {
      <span class="hljs-attr">destPath</span>: <span class="hljs-string">'articles'</span>,
      <span class="hljs-attr">query</span>: <span class="hljs-string">'Post'</span>
    },
    <span class="hljs-attr">cache</span>: process.env[<span class="hljs-string">'NODE_ENV'</span>] !== <span class="hljs-string">'production'</span>,
    <span class="hljs-attr">locale</span>: <span class="hljs-string">'en-AU'</span> <span class="hljs-comment">// it's important you get this right.</span>
  })
)
.build( ... )
</code></pre>
<div class="pilwrap" id="options">
  <h3>
    <a href="#options" name="options" class="pilcrow"></a>
options
  </h3>
</div>
<ul>
<li><code>space</code> {String} (required) id of contentful space you wish to scrape</li>
<li><code>destPath</code> {String} (required) the path under which you want to place the   scraped files</li>
<li><code>cache</code> {Boolean|String} (default: <code>true</code>) cache mode</li>
<li><code>locale</code> {String} (default: <code>en-US</code>) locale (<em>!important</em>)</li>
<li><code>files</code> {Object} (optional) <a href=".html">file creation</a> opts</li>
<li><code>files.destPath</code> {String} path under which to place files</li>
<li><code>files.coerce</code> {Function} fn to convert files</li>
<li><code>files.query</code> {String|Object} <a href="#queries.html">query</a> for files to create</li>
</ul>
<div class="pilwrap" id="contentful-data-structure">
  <h3>
    <a href="#contentful-data-structure" name="contentful-data-structure" class="pilcrow"></a>
contentful data structure
  </h3>
</div>
<p>Finding different properties in the returned data may not be intuitive. If you're struggling you should try <a href="https://github.com/leviwheatcroft/metalsmith-debug-ui" title="metalsmith-debug-ui repo">metalsmith-debug-ui</a>, and take a look at the data structures returned by the <a href="https://www.contentful.com/developers/docs/references/content-delivery-api/" title="contentful api">contentful api</a>.</p>
<div class="pilwrap" id="cache-modes">
  <h3>
    <a href="#cache-modes" name="cache-modes" class="pilcrow"></a>
cache modes
  </h3>
</div>
<ul>
<li><em>full cache</em> <code>true</code> - in this mode everything will be pulled down once, and no further requests to the contentful api will be issued in future builds</li>
<li><em>no cache</em> <code>false</code> - this invalidates cache every build</li>
<li><em>sync</em> <code>{string}</code> - any string understood by <a href="https://www.npmjs.com/package/parse-duration" title="parse-duration repo">parse-duration</a>. Will use the sync api to request updated items if last sync is older than the duration specified.</li>
</ul>
<div class="pilwrap" id="queries">
  <h3>
    <a href="#queries" name="queries" class="pilcrow"></a>
queries
  </h3>
</div>
<p>This plugin doesn't use contentful queries, it just pulls down everything and stores it in your cache. You can then query your cache with <a href="https://github.com/louischatriot/nedb#basic-querying" title="nedb readme">nedb queries</a>.</p>
<p>The <code>contentful</code> property in metadata exposes two functions <code>find</code> and <code>findOne</code>. Consider
the following example. Both return promises which resolve to the query result, and both accept a single parameter: a nedb search query.</p>
<p>Usage example:</p>
<pre><code class="javascript">Metalsmith(<span class="hljs-string">'src'</span>)
.use(
  contentful({
    <span class="hljs-attr">space</span>: <span class="hljs-string">'aH7WHo2HQFrX5CHbGZx4'</span>,
    <span class="hljs-attr">accessToken</span>: <span class="hljs-string">'9aXKQnP2UjjEeSSUcyGCMAOhnm4Vsf8u'</span>
  })
)
.use(<span class="hljs-function">(<span class="hljs-params">files, metalsmith</span>) =&gt;</span> {
  <span class="hljs-keyword">let</span> query = {<span class="hljs-string">'fields.file.contentType'</span>: <span class="hljs-regexp">/^image/</span>}
  <span class="hljs-keyword">return</span> metalsmith.metadata().contentful.find(query)
  .then(<span class="hljs-function">(<span class="hljs-params">images</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> imageUrls = images.map(<span class="hljs-function">(<span class="hljs-params">image</span>) =&gt;</span> image.fields.file.url)
    metalsmith.metadata().contentfulImageUrls = imageUrls
  })
})
.build( ... )
</code></pre>
<div class="pilwrap" id="file-creation">
  <h3>
    <a href="#file-creation" name="file-creation" class="pilcrow"></a>
file creation
  </h3>
</div>
<p>This behaviour is optional. If you pass in a <code>files</code> property files will be created in the metalsmith files structure.</p>
<p>The <code>query</code> option determines what items from the contentful space will be used to create files, it can either be a <a href="https://github.com/louischatriot/nedb#basic-querying" title="nedb readme">nedb query</a>, or the name of a ContentType.</p>
<p><code>destPath</code> determines the root path under which the files will be created. All files are created with a .md extension to allow for easy identification by other plugins.</p>
<p>The plugin makes a good attempt at creating a metalsmith file, but depending on your space configuration you may need to augment it with a custom <code>coerce</code> function. For example, the demo contentful spaces use a <code>body</code> field for contents (but <code>contents</code> will work too). If you use something else like <code>article</code> then you'll need to map that to <code>contents</code> yourself, as shown.</p>
<pre><code class="javascript">Metalsmith(<span class="hljs-string">'src'</span>)
.use(
  contentful({
    <span class="hljs-attr">space</span>: <span class="hljs-string">'aH7WHo2REFrZ6CHbGZx4'</span>,
    <span class="hljs-attr">accessToken</span>: <span class="hljs-string">'9aXKQnP2UjjEeTTUcyGCMAOmhn4Vsf8u'</span>,
    <span class="hljs-attr">files</span>: {
      <span class="hljs-attr">destPath</span>: <span class="hljs-string">'articles'</span>,
      <span class="hljs-attr">query</span>: <span class="hljs-string">'Post'</span>,
      <span class="hljs-attr">coerce</span>: <span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> {
        file.contents = Buffer.from(file.article)
        <span class="hljs-keyword">return</span> file
      }
    }
  })
)
.build( ... )
</code></pre>
<div class="pilwrap" id="content-types">
  <h3>
    <a href="#content-types" name="content-types" class="pilcrow"></a>
content types
  </h3>
</div>
<p>These will only be retrieved once after cache is invalidated, so if you're using sync mode, and change or add content types, you'll need to invalidate your cache to pull down the updated content types.</p>
<div class="pilwrap" id="locales">
  <h3>
    <a href="#locales" name="locales" class="pilcrow"></a>
locales
  </h3>
</div>
<p>This plugin depends heavily on contentful's sync api, which returns data nested under locale strings like this:</p>
<pre><code>{
  sys: {...},
  fields: {
    title: {
      'en-US': 'some title'
    }
  }
}
</code></pre>
<p>There might be a better way to deal with this (see <a href="https://github.com/leviwheatcroft/metalsmith-contentful/issues/3" title="locale issue">locale issue</a>) but for the moment you need to pass in a <code>locale</code> option which will be used to localise the above data structure so <code>fields.title === 'some title'</code>.</p>
<div class="pilwrap" id="author">
  <h3>
    <a href="#author" name="author" class="pilcrow"></a>
Author
  </h3>
</div>
<p>Levi Wheatcroft <a href="mailto:levi@wht.cr.html">levi@wht.cr</a></p>
<div class="pilwrap" id="contributing">
  <h3>
    <a href="#contributing" name="contributing" class="pilcrow"></a>
Contributing
  </h3>
</div>
<p>Contributions welcome; Please submit all pull requests against the master branch.</p>
<div class="pilwrap" id="license">
  <h3>
    <a href="#license" name="license" class="pilcrow"></a>
License
  </h3>
</div>
<ul>
<li><strong>MIT</strong> : http://opensource.org/licenses/MIT</li>
</ul>
</div>
  </div>
</body>
</html>
